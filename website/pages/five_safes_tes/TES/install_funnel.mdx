import { Steps, Callout, Tabs } from "nextra/components";

# Funnel TES

[Funnel](https://github.com/ohsu-comp-bio/funnel) is an implementation of the GA4GH Task Execution Schemas. It provides an API server,
multiple storage backends, multiple compute backends and a web UI.
For the purposes of the All In One stack we will be configuring the TRE Agent to use Funnel as the TES compatible execution backend and any outputs from the execution will be stored in the TRE Layer MinIO instance.

<Steps>

## Set up MinIO Access key

Navigate to the MinIO instance of the TRE Layer (hosted at: [localhost:9002](http://localhost:9002)).
If you see the option to login with `SSO_Identifier`, use the following credentials:

```yaml copy
Username: globaladminuser
Password: password123
```

You can also login to Minio with root credentials using the option `Use Credentials` under `Other Authentication methods`:

```yaml copy
Username: minio
Password: minio123
```

To create the access keys, in the MinIO console navigate to **_Access Keys -> Create access key_**

![MinIO](/images/MinioAccessKey.png)

## Install Funnel

Instructions on how to install Funnel can be found [here](https://ohsu-comp-bio.github.io/funnel/download/)

<Callout> It is currently only available on linux and macOS.</Callout>

<Tabs items={['Install Script', 'Homebrew', 'Manual Binary Install', 'Build from Source']}>
 <Tabs.Tab>
   This installs the latest release candidate at the time of writing `v0.11.7-rc.12`. 
    ```bash copy
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/ohsu-comp-bio/funnel/refs/heads/develop/install.sh)" -- v0.11.7-rc.12
    ```
 </Tabs.Tab>

 <Tabs.Tab>
 The latest version available via `brew` is `v0.11.3`. 
    ```bash copy
    brew tap ohsu-comp-bio/formula

    brew install funnel
    ```

 </Tabs.Tab>
 
 <Tabs.Tab>
   This installs the most recent Funnel release at the time of writing `v0.11.6`.
   <Tabs items={['MacOS', 'Linux']}>
      <Tabs.Tab>
         For Intel (AMD64) architecture: 
         ```bash copy
         wget https://github.com/ohsu-comp-bio/funnel/releases/download/v0.11.6/funnel-darwin-amd64-v0.11.6.tar.gz
         tar -xzvf funnel-darwin-amd64-v0.11.6.tar.gz
         sudo mv funnel /usr/local/bin/ 
         ```

         For Apple Silicon (ARM64) architecture:
         ```bash copy
         wget https://github.com/ohsu-comp-bio/funnel/releases/download/v0.11.6/funnel-darwin-arm64-v0.11.6.tar.gz
         tar -xzvf funnel-darwin-arm64-v0.11.6.tar.gz
         sudo mv funnel /usr/local/bin/
         ```

      </Tabs.Tab>

      <Tabs.Tab>
         For Intel (AMD64) architecture:
         ```bash copy
         wget https://github.com/ohsu-comp-bio/funnel/releases/download/v0.11.6/funnel-linux-amd64-v0.11.6.tar.gz
         tar -xzvf funnel-linux-amd64-v0.11.6.tar.gz
         sudo mv funnel /usr/local/bin/
         ```

         For ARM64 architecture:
         ```bash copy
         wget https://github.com/ohsu-comp-bio/funnel/releases/download/v0.11.6/funnel-linux-arm64-v0.11.6.tar.gz
         tar -xzvf funnel-linux-arm64-v0.11.6.tar.gz
         sudo mv funnel /usr/local/bin/
         ```
      </Tabs.Tab>

   </Tabs>
 </Tabs.Tab>

 <Tabs.Tab>
   In order to build the latest development code, run:
   ```bash copy
   git clone https://github.com/ohsu-comp-bio/funnel.git
   cd funnel
   make
   ```
   This requires Go 1.21+ to be installed. 
 </Tabs.Tab>

</Tabs>

## Check if funnel has been successfully installed

```bash copy
funnel --help
```

## Funnel config file

Funnel will need access to the TRE layer MinIO. Once funnel is installed create a config.yaml file.

- `Endpoint` is where the instance of MinIO in the TRE Layer is hosted.
- `Access key` & `Secret` as created in the [previous step](#set-up-minio-access-key).

```yaml filename="config.yml" copy
GenericS3:
  - Disabled: false
    Endpoint: "localhost:9002" # URL where the MinIO instance is hosted. The port stays the same, change the host to match your environment.
    Key: "<access key>"
    Secret: "<secret>"
```

## Run Funnel

Run the funnel server using the config created above.

```bash copy
funnel server run -c config.yml
```

</Steps>
