import { Callout } from "nextra/components";

# Working of 5 Safes TES

Weaves is the combination which implements FIVE Safe TES principles as a software which includes adhering governance and standards. 

The **FIVE Safes** TES follows a **Fan-out pattern for architecture design**.

### What is Fan-out pattern?

**Fan-out** is a execution pattern where the gateway (Central Service) receives a single client query is resolved by parallel calls to multiple domain services. The fan-out occurs when resolving a single query that requires data from multiple domain services.

**Fan-out Federation** is a specific implementation of the pattern where a single operation from a client can trigger multiple parallel requests from the central service to various services and then unify their responses into one and returns the unified payload to the client.


<figure style={{ textAlign: 'center', paddingTop: '20px' }}>
  <img 
    src="/images/fan-outArchitecture.png" 
    alt="Fan-out Architecture Pattern" 
    width="500"
    style={{ display: "block", margin: "0 auto" }}
  />
    <figcaption style={{ fontStyle: 'italic', fontSize: '0.7em', marginTop: '8px' }}>
        Figure 1: illustrates Fan-out architecture pattern
    </figcaption>
</figure>

### Architecture & Overview: Five Safe TES

The 5 Safe TES (Trusted Execution Service) is designed to handle sensitive data analysis within a secure and controlled environment. The architecture followed by a Fan-out Architecture for the implementation and is organized into multiple layers and application components.

<Callout type="warning">
    As of now, the aggregation part in the fan-out architecture is not perform by itself as the user needs to aggregate by themself or run another job.
</Callout>

The 5 Safe TES is divided into multiple layers of process and multiple app stack as discussed below.

**The layers of the architecture are:**

- **Submission Layer**: Entrypoint for user requests, authentication, and authorisation.
- **Storage Layer (User)**: Centralized storage for user inputs, metadata and artefacts.
- **TRE Layer**: Core processing layer for data analysis.
- **Storage Layer (Collection of Results)**: Secure storage for storing analysis results for the data owner.

**The Five Safe TES app stack includes:**

- **Submission App:** Handles user submissions.
- **TRE Agent App:** Manages task execution within the TRE for data analytics.
- **Egress App:** Controls the release of results to users


<figure style={{ textAlign: 'center', paddingTop: '20px' }}>
  <img 
    src="/images/five-safe-tesArchitecture.png"
    alt="Five Safe TES Architecture" 
    width="700"
    style={{ display: "block", margin: "0 auto" }}
  />
    <figcaption style={{ fontStyle: 'italic', fontSize: '0.7em', marginTop: '8px' }}>
        Figure 2: illustrates app structure and working of Five Safe TES Architecture
    </figcaption>
</figure>

**Operational Overview: Five Safe TES**

The high level overview of working of the Five Safe TES is as follows:


<u style={{ display: 'block', marginTop: '20px' }}>
  <strong>Submission App</strong>
</u>
<div>
    - The process begins with the end user or researcher submitting a request for the desired analysis over the Trusted Research Environments. Then, authentication and authorisation checks are performed to ensure the user is assigned to the relevant project.
    - Once the request is accepted by the Trusted Research Environments Agent(based on the authentication & Authorisation), which contains code for analysis, metadata information, etc and saves the artefacts in the centralised storage at the user level.
    - The request is then placed in a queue as a task for the corresponding nodes in the federated network, and the user is notified that their request has been accepted.
</div>


<u style={{ display: 'block', marginTop: '20px' }}>
  <strong>TRE Agent App</strong>
</u>
<div>
    - The TRE Agent in the TRE Layer monitors the queue for new jobs (tasks). Once identified, the task are taken from the queue and sent to the for authorisation by TREs.
    - Then, a tool is called Camunda is used to dynamically inject the database connection string and credentials into the Funnel container to connect the database.
    - All together, complete payload is send to the Task Execution Service API which receives code & message and translates them into the common one.
    - Then, the standardised payload is sent by the TES API to a Docker image which executes the analysis query on the database with the respected database crentials managed by camunda.
    - The results of this analysis are then saved in storage at the TRE Agent Owner Level.
</div>

<u style={{ display: 'block', marginTop: '20px' }}>
  <strong>Egress App</strong>
</u>
<div>
    - After the analysis results are stored, the TRE notifies the data owner (a designated human reviewer) to approve the release of results.
    - The owner can now reviews the output and, if approved, authorises the egress.
    - Upon approval, the results are retrieved from storage and sent back through the submission layer and finally, the end user or researcher receives their requested analysis results.
</div>