import { Steps, Callout, Table, Td, Th, Tr } from "nextra/components";

# Deploy a TRE Layer

This page contains:

- a summary of what is involved when deploying a Five Safes TES TRE Layer
- a Sample Deployment Guide
  - with recommendations for deploying in Production

## Component Summary

Here is a summary of the required components which make up the TRE Layer:

| Component                 | Notes                                                                                                                                   |
| ------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| **KeyCloak**              | The TRE Agent and Egress apps each require a Keycloak realm containing users and clients authorised to access them                      |
| **Minio**                 | An Amazon S3 compatible TRE Storage service                                                                                             |
| **RabbitMQ**              | A message broker used for queueing                                                                                                      |
| **PostgreSQL**            | A database for the Submission apps to keep local state                                                                                  |
| **Hashicorp Vault**       | Used for accessing ephemeral credentials as secrets                                                                                     |
| **OpenLDAP**              | Used to provide ephemeral credentials for Trino (if in use as a datasource)                                                             |
| **Camunda Connectors**    | A REST API allowing other services (e.g. TRE Agent) to integrate with Camunda                                                           |
| **Camunda Orchestration** | A consolidated service that combines Camunda functionality via [Zeebe + Operate + Tasklist](https://camunda.com/process-orchestration/) |
| **ElasticSearch**         | Used for Camunda's local datastore such as workflow state                                                                               |
| **TRE-Camunda**           | A service defining the handlers for ephemeral credentials management. Registers the handlers with Camunda, via Zeebe                    |
| **TRE Agent API**         | A REST API for TRE Agent functionality                                                                                                  |
| **TRE Agent GUI**         | A Web Frontend for TRE Admins to log into and interact with the TRE Agent                                                               |
| **Egress API**            | A REST API for Egress Portal functionality                                                                                              |
| **Egress GUI**            | A Web Frontend for Egress Officers to log into and interact with the Egress Portal                                                      |
| **TES Backend**           | A standard GA4GH TES implementation to execute the analysis                                                                             |

You may choose how to distribute your own deployment of these components, as long as they are able to communicate with each other over the network.

For some components, such as KeyCloak or MinIO, you may wish to use your own existing deployments.

{/* TODO: Keycloak realm setup guide */}

### User accessible components

A subset of the components will need to be accessible by users, outside of the TRE Layer environent:

| Component         | Reason                                                                                                               |
| ----------------- | :------------------------------------------------------------------------------------------------------------------- |
| **KeyCloak**      | So that users can authenticate and admins can manage the TRE Agent and Egress KeyCloak Realms                        |
| **TRE Agent GUI** | So that TRE Admins can log into and interact with the TRE Agent                                                      |
| **TRE Agent API** | So that TRE Agent GUI browser functionality, and optionally other services, can interact with the TRE Agent REST API |
| **Egress GUI**    | So that Egress Officers can log into and interact with the Egress Portal                                             |
| **Egress API**    | _Optional_. So that other services can integrate with the Egress REST API                                            |

## Sample Deployment Guide

<Callout type="info">
  Note that this guide is a *sample*. It can be modified to reflect the your own
  infrastructure and configuration choices.
</Callout>

This guide deploys all the components of the TRE Layer (except the TES Backend) on a single host (e.g. a Virtual Machine) using Docker Compose.

All the components are deployed on suitable Docker networks and can communicate with each other as required.

It also automatically configures the necessary KeyCloak realms, ready for following our other guides.

<Callout>
  Because the TES Backend is not part of this deployment, it will need to be
  deployed separately and configured to communicate with the required
  components.

We also provide guidance for [installing Funnel](/five_safes_tes/reference_implementation/TES/install_funnel) as a TES Backend.

</Callout>

### User accessible components

Components which may need to be accessed from outside the host are forwarded to the host on specific ports

| Component         | Ports        |
| ----------------- | :----------- |
| **KeyCloak**      | HTTP: `8085` |
| **TRE Agent GUI** | HTTP: `8989` |
| **TRE Agent API** | HTTP: `8072` |
| **Egress GUI**    | HTTP: `8100` |
| **Egress API**    | HTTP: `8101` |

In this sample, where the TES Backend is deployed elsewhere, the TES Backend will also need access to some components:

| Component         | Ports            |
| ----------------- | :--------------- |
| **MinIO**         | API HTTP: `9002` |
| **TRE Agent API** | HTTP: `8072`     |

<Callout>
  Remember the TES Backend's environment will also need network access to
  project data sources, in order for analysis to run against them.
</Callout>

This sample also includes some additional components useful for diagnostic purposes:

| Component   | Notes                                | Ports        |
| ----------- | :----------------------------------- | ------------ |
| **Seq**     | Logs aggregator and web-based viewer | HTTP: `5341` |
| **Adminer** | Web-based PostgreSQL client          | HTTP: `8087` |

### Production Recommendations

To use this sample as a starting point for a production deployment, some [general recommendations](/five_safes_tes/reference_implementation/deploy_production) should be considered.

The ports specified above can be used for configuring a reverse proxy for access to the necessary components.

## Get Started

### Prerequisites

- Docker and Docker Compose installed. For Linux/Ubuntu VMs, you can follow this [guide](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository)
- [Git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) installed on your machine.

### Deployment Steps

To deploy a TRE Agent and Data Egress:

<Steps>

#### Clone the repository

```bash copy
git clone https://github.com/SwanseaUniversityMedical/5S-TES-deployment.git
```

#### Go to the TRE Layer directory

Within the 5S-TES-deployment directory, the TRE Layer docker-compose and configuration files are in the `TRE` [directory](https://github.com/SwanseaUniversityMedical/5S-TES-deployment/tree/main/TRE):

```bash copy
cd TRE
```

#### Configure the .env file

Open the `.env` file in the `TRE` directory and configure the environment variables.

The descriptions of the environment variables and the guide to set them are as follows:

<Table>
  <thead>
    <Tr>
      <Th>Environment Variable</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`dareVer`</Td>
      <Td>
        The version of the TRE Agent app you are deploying. Find the version
        [here](https://github.com/SwanseaUniversityMedical/DARE-Control/releases),
        between `v` and `-containers`. For example, `2.15.1` is the version for
        the release `v2.15.1-containers`.
      </Td>
    </Tr>
    <Tr>
      <Td>`PGLOGIN` and `PGPASSWORD`</Td>
      <Td>
        The admin credentials for the PostgreSQL database used by the TRE Agent.
      </Td>
    </Tr>
    <Tr>
      <Td>
        `TRE_DATA_SERVER` `TRE_DATA_PORT` `TRE_DATA_DATABASE` `TRE_DATA_USER`
        `TRE_DATA_PASSWORD`
      </Td>
      <Td>
        The credentials for the PostgreSQL database used to hold the TRE data,
        e.g., OMOP CDM data. Camunda will use these credentials to create the
        ephemeral user accounts for the TES executing agent (e.g., Funnel) to
        access the TRE data.
      </Td>
    </Tr>
    <Tr>
      <Td>`DemoMode`</Td>
      <Td>
        Set to `true` if you'd like to simulate execution, otherwise default to
        `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreName`</Td>
      <Td>The name identifier for this TRE instance.</Td>
    </Tr>
    <Tr>
      <Td>`KeyCloakDemoMode`</Td>
      <Td>Allows Keycloak to not require https. Default is `true`.</Td>
    </Tr>
    <Tr>
      <Td>`EphemeralCredentials`</Td>
      <Td>
        Enable ephemeral credentials functionality. Set to `true` to enable.
      </Td>
    </Tr>
    <Tr>
      <Td>`KeycloakHostName`</Td>
      <Td>
        The hostname of the Keycloak server. For example,
        `http://localhost:8085` or `https://my-keycloak.net`.
      </Td>
    </Tr>
    <Tr>
      <Td>`UseTESK`</Td>
      <Td>Set to `true` to execute with a TES implementation.</Td>
    </Tr>
    <Tr>
      <Td>`UseRabbit`</Td>
      <Td>
        Set to `true` to use RabbitMQ message broker, otherwise set to `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TesAPIUrl`</Td>
      <Td>
        Where TESK or Funnel API is hosted. For example,
        `http://host.docker.internal:8000/v1/tasks` (when Funnel is hosted
        locally) or `http://my-funnel.com/tasks`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TesOutputBucketPrefix`</Td>
      <Td>
        Output bucket prefix for the TES executing agent to write results to.
        For example, `s3://`.
      </Td>
    </Tr>
    <Tr>
      <Td>`MinioTreIdentityID`</Td>
      <Td>Name of the TRE's Minio client, i.e., `Dare-TRE-Minio`.</Td>
    </Tr>
    <Tr>
      <Td>`MinioTreOpenidSecret`</Td>
      <Td>
        The OpenID secret for the Minio client of Dare-TRE realm. There is a
        default value in the realm configuration, but you should regenerate it
        for production deployments. Do this by navigating to `Dare-TRE` realm ->
        `Clients` -> `Dare-TRE-Minio` -> `Credentials`. Then click `Regenerate`
        and copy the new value into this environment variable.
      </Td>
    </Tr>
    <Tr>
      <Td>`MinioTreIdentityConfigURL`</Td>
      <Td>
        The OpenID configuration URL for the Dare-TRE realm. For example,
        `http://keycloak:8080/realms/Dare-TRE/.well-known/openid-configuration`
        (if Keycloak is running on the same Docker network) or
        `https://my-keycloak.net/realms/Dare-TRE/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`MinioRootUser`</Td>
      <Td>The root user for the Submission Layer Minio server.</Td>
    </Tr>
    <Tr>
      <Td>`MinioRootPass`</Td>
      <Td>The root password for the Submission Layer Minio server.</Td>
    </Tr>
    <Tr>
      <Td>`TreMinioAdminUser`</Td>
      <Td>The admin user for the TRE Minio server.</Td>
    </Tr>
    <Tr>
      <Td>`TreMinioAdminPassword`</Td>
      <Td>The admin password for the TRE Minio server.</Td>
    </Tr>
    <Tr>
      <Td>`MinioBrowserHost`</Td>
      <Td>
        This is useful if you are using a reverse proxy to access the Minio
        server. Read more about this
        [here](https://docs.min.io/enterprise/aistor-object-store/reference/aistor-server/settings/console/#env-minio-browser-redirect-url).
      </Td>
    </Tr>
    <Tr>
      <Td>`MinioTreUrl`</Td>
      <Td>
        The URL for the TRE Minio server used by Egress, for internal access
        within Docker network. For example, `http://minio:9002`.
      </Td>
    </Tr>
    <Tr>
      <Td>`MinioTreAdminConsoleUrl`</Td>
      <Td>
        The URL for the TRE Minio server's admin console. For example,
        `http://minio:9003`.
      </Td>
    </Tr>
    <Tr>
      <Td>`submissionMinioUrl`</Td>
      <Td>
        Point to Submission Layer Minio server, used by TRE Agent. For example,
        `http://host-of-submission-layer:9000`.
      </Td>
    </Tr>
    <Tr>
      <Td>`submissionMinioAdminConsole`</Td>
      <Td>
        The URL for the Submission Layer's Minio admin console. For example,
        `http://host-of-submission-layer:9001`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreUiPublicUrl`</Td>
      <Td>
        The public URL for the TRE Agent GUI. For example,
        `http://my-TRE-host:8989`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreApiPublicUrl`</Td>
      <Td>
        The public URL for the TRE Agent API. For example,
        `http://my-TRE-host:8072`.
      </Td>
    </Tr>
    <Tr>
      <Td>`CAMUNDA_VERSION`</Td>
      <Td>The version of Camunda to deploy.</Td>
    </Tr>
    <Tr>
      <Td>`CAMUNDA_BUNDLE_VERSION`</Td>
      <Td>The version of Camunda Bundle to deploy.</Td>
    </Tr>
    <Tr>
      <Td>`ELASTIC_VERSION`</Td>
      <Td>
        The version of Elasticsearch to deploy for Camunda's local datastore.
      </Td>
    </Tr>
    <Tr>
      <Td>`CredentialAPISettingsStartWebhookUrl`</Td>
      <Td>
        The webhook URL for starting credentials via Camunda connectors. For
        example, `http://connectors:8080/inbound/StartCredentials`.
      </Td>
    </Tr>
    <Tr>
      <Td>`CredentialAPISettingsRevokeWebhookUrl`</Td>
      <Td>
        The webhook URL for revoking credentials via Camunda connectors. For
        example, `http://connectors:8080/inbound/RevokeCredentials`.
      </Td>
    </Tr>
    <Tr>
      <Td>`syncSchedule`</Td>
      <Td>
        Sync Projects & Users between TRE & Submission Layer - default every 10
        minutes (in minutes).
      </Td>
    </Tr>
    <Tr>
      <Td>`scanSchedule`</Td>
      <Td>
        Scan Submission Layer for available submissions - default every 1 minute
        (in minutes).
      </Td>
    </Tr>
    <Tr>
      <Td>`EnableExternalHangfire`</Td>
      <Td>
        Set to `true` to enable external Hangfire, otherwise set to `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakUseRedirect`</Td>
      <Td>
        If this is set to `true`, the Egress Layer will use redirects for
        Keycloak authentication. Default is `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakBaseRealmAddress`</Td>
      <Td>
        This is the realm address for the Egress's Keycloak server. For example,
        `http://keycloak:8080/realms/Data-Egress` or
        `https://my-keycloak.net/realms/Data-Egress`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakAuthority`</Td>
      <Td>
        The OpenID authority URL for the Egress Keycloak realm. For example,
        `http://keycloak:8080/realms/Data-Egress/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakMetadataAddress`</Td>
      <Td>
        The OpenID metadata address URL for the Egress Keycloak realm. For
        example,
        `http://keycloak:8080/realms/Data-Egress/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressValidAudiences`</Td>
      <Td>
        The valid audiences for the Egress Keycloak token. Default is
        `Data-Egress-UI,Data-Egress-API`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakClientUIRedirectURL`</Td>
      <Td>
        The URL for the Egress Layer's Keycloak redirect URL. For example,
        `https://localhost:8100/`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakTokenExpiredAddressUI`</Td>
      <Td>
        The URL for the Egress Layer's Keycloak token expired address. For
        example, `http://localhost:8100/Account/LoginAfterTokenExpired`.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakSecret`</Td>
      <Td>
        The OpenID secret for the Egress Keycloak client `Data-Egress-API`. Find
        and regenerate this secret by navigating to `Data-Egress` realm ->
        `Clients` -> `Data-Egress-API` -> `Credentials`. Then click `Regenerate`
        and copy the new value into this environment variable.
      </Td>
    </Tr>
    <Tr>
      <Td>`EgressKeyCloakClientID`</Td>
      <Td>
        The client ID for the Egress Keycloak client, i.e., `Data-Egress-API`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIAddressURL`</Td>
      <Td>
        The Submission API address URL. For example,
        `http://host-of-submission-layer:5034`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakUseRedirect`</Td>
      <Td>
        If this is set to `true`, the Submission API will use redirects for
        Keycloak authentication. Default is `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakClientUIRedirectURL`</Td>
      <Td>
        The URL for the Submission API's Keycloak redirect URL. For example,
        `http://host-of-submission-layer:8989/`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakClientId`</Td>
      <Td>
        The client ID for the Submission API Keycloak client, i.e.,
        `Dare-Control-API`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakBaseRealmAddress`</Td>
      <Td>
        This is the realm address for the Submission's Keycloak server. For
        example, `http://keycloak:8080/realms/Dare-Control` (if Keycloak is
        running on the same Docker network) or
        `https://my-keycloak.net/realms/Dare-Control`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakAuthority`</Td>
      <Td>
        The OpenID authority URL for the Submission Keycloak realm. For example,
        `http://keycloak:8080/realms/Dare-Control/.well-known/openid-configuration`
        or
        `https://my-keycloak.net/realms/Dare-Control/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakMetadataAddress`</Td>
      <Td>
        The OpenID metadata address URL for the Submission Keycloak realm. Same
        as `SubmissionAPIKeyCloakAuthority`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIValidAudiences`</Td>
      <Td>
        The valid audiences for the Submission API Keycloak token. Default is
        `Dare-Control-UI,Dare-Control-API,Dare-Control-Minio`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakTokenExpiredAddressUI`</Td>
      <Td>
        The URL for the Submission API's Keycloak token expired address. For
        example,
        `http://host-of-submission-layer:8989/Account/LoginAfterTokenExpired`.
      </Td>
    </Tr>
    <Tr>
      <Td>`SubmissionAPIKeyCloakSecret`</Td>
      <Td>
        The OpenID secret for the Submission API Keycloak client
        `Dare-Control-API`. Find and regenerate this secret by navigating to
        `Dare-Control` realm -> `Clients` -> `Dare-Control-API` ->
        `Credentials`. Then click `Regenerate` and copy the new value into this
        environment variable.
      </Td>
    </Tr>
    {/* <Tr>
      <Td>`KeyCloakUseRedirect`</Td>
      <Td>
        If this is set to `true`, the TRE Agent will use redirects for Keycloak
        authentication. Default is `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`KeyCloakClientUIRedirectURL`</Td>
      <Td>
        The URL for the TRE Agent's Keycloak redirect URL. For example,
        `http://host-of-tre:8888/`.
      </Td>
    </Tr>
    <Tr>
      <Td>`KeyCloakTokenExpiredAddressUI`</Td>
      <Td>
        The URL for the TRE Agent's Keycloak token expired address. For example,
        `http://host-of-tre:8888/Account/LoginAfterTokenExpired`.
      </Td>
    </Tr> */}
    <Tr>
      <Td>`TreKeyCloakUseRedirect`</Td>
      <Td>
        If this is set to `true`, the TRE UI will use redirects for Keycloak
        authentication. Default is `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakClientUIRedirectURL`</Td>
      <Td>
        The URL for the TRE UI's Keycloak redirect URL. For example,
        `http://host-of-tre:8989/`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakTokenExpiredAddressUI`</Td>
      <Td>
        The URL for the TRE UI's Keycloak token expired address. For example,
        `http://host-of-tre:8989/Account/LoginAfterTokenExpired`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakSecret`</Td>
      <Td>
        The OpenID secret for the TRE UI Keycloak client `Dare-TRE-UI`. Find and
        regenerate this secret by navigating to `Dare-TRE` realm -> `Clients` ->
        `Dare-TRE-UI` -> `Credentials`. Then click `Regenerate` and copy the new
        value into this environment variable.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakBaseRealmAddress`</Td>
      <Td>
        This is the realm address for the TRE's Keycloak server. For example,
        `http://keycloak:8080/realms/Dare-TRE` or
        `https://my-keycloak.net/realms/Dare-TRE`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakAuthority`</Td>
      <Td>
        The OpenID authority URL for the TRE Keycloak realm. For example,
        `http://keycloak:8080/realms/Dare-TRE/.well-known/openid-configuration`
        or
        `https://my-keycloak.net/realms/Dare-TRE/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakClientId`</Td>
      <Td>
        The client ID for the TRE UI Keycloak client, i.e., `Dare-TRE-UI`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreKeyCloakMetadataAddress`</Td>
      <Td>
        The OpenID metadata address URL for the TRE Keycloak realm. Same as
        `TreKeyCloakAuthority`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAccountManagementURLUI`</Td>
      <Td>
        The URL for the TRE UI's Keycloak account management. For example,
        `http://localhost:8085/realms/Dare-TRE/account`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreValidAudiences`</Td>
      <Td>
        The valid audiences for the TRE Keycloak token. Default is
        `Dare-TRE-API,Dare-TRE-UI`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakUseRedirect`</Td>
      <Td>
        If this is set to `true`, the TRE API will use redirects for Keycloak
        authentication. Default is `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakClientUIRedirectURL`</Td>
      <Td>
        The URL for the TRE API's Keycloak redirect URL. For example,
        `http://localhost:8989/`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakTokenExpiredAddressUI`</Td>
      <Td>
        The URL for the TRE API's Keycloak token expired address. For example,
        `http://localhost:8989/Account/LoginAfterTokenExpired`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakSecret`</Td>
      <Td>
        The OpenID secret for the TRE API Keycloak client `Dare-TRE-API`. Find
        and regenerate this secret by navigating to `Dare-TRE` realm ->
        `Clients` -> `Dare-TRE-API` -> `Credentials`. Then click `Regenerate`
        and copy the new value into this environment variable.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakBaseRealmAddress`</Td>
      <Td>
        This is the realm address for the TRE API's Keycloak server. For
        example, `http://keycloak:8080/realms/Dare-TRE`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakAuthority`</Td>
      <Td>
        The OpenID authority URL for the TRE API Keycloak realm. For example,
        `http://keycloak:8080/realms/Dare-TRE/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakClientId`</Td>
      <Td>
        The client ID for the TRE API Keycloak client, i.e., `Dare-TRE-API`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIKeyCloakMetadataAddress`</Td>
      <Td>
        The OpenID metadata address URL for the TRE API Keycloak realm. For
        example,
        `http://keycloak:8080/realms/Dare-TRE/.well-known/openid-configuration`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIAccountManagementURLUI`</Td>
      <Td>
        The URL for the TRE API's Keycloak account management. For example,
        `http://localhost:8085/realms/Dare-TRE/account`.
      </Td>
    </Tr>
    <Tr>
      <Td>`TreAPIValidAudiences`</Td>
      <Td>
        The valid audiences for the TRE API Keycloak token. Default is
        `Dare-TRE-API,Dare-TRE-UI`.
      </Td>
    </Tr>
  </tbody>
</Table>

<Callout>
  Instructions on how to set up a Funnel TES API executing agent can be found
  [here](/five_safes_tes/reference_implementation/TES/install_funnel)
</Callout>

<Callout type="info">
  You can find an example `.env` file
  [here](https://github.com/SwanseaUniversityMedical/5S-TES-deployment/blob/main/TRE/.env).
</Callout>

#### Run docker compose

```bash copy
docker compose up -d
```

#### Check-in

After the containers are running, if you have configured the ports for the TRE Agent components for [user accessibility](#user-accessible-components),
you can access the TRE Agent UI and Egress UI by navigating to `http://<hostname>:8989` and `http://<hostname>:8100`, respectively, in your browser.

#### Next steps

- Add a new user in the `Dare-TRE` Keycloak realm with appropriate permissions, then use this user credentials to access the TRE Agent UI.
- Add a new user in the `Data-Egress` Keycloak realm with appropriate permissions, then use this user credentials to access the Egress UI.
- Connect the TRE Agent to the Submission Layer by following this [guide](/submission/guides/addtreagent).
- Connect the TRE Agent to Egress by following this [guide](/tre_agent/guides/connecttoegress).

</Steps>
